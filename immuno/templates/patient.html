{% extends "layout.html" %}

{% block title %}
Patient {{ display_id }}
{% endblock %}

{% block pagetitle %}
Patient {{ display_id }}
{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/css/peptides.css">
{% endblock %}

{% block sidebar %}
<li class="active"><a href="{{ url_for('patient', display_id=display_id) }}">{{ display_id }}</a></li>
<li><a href="{{ url_for('hla_types', display_id=display_id) }}">HLA Types</a></li>
<li><a href="{{ url_for('variants', display_id=display_id) }}">Variants</a></li>
<li><a href="{{ url_for('export', display_id=display_id) }}">Export Peptides</a></li>
{% endblock %}

{% block content %}
<div id="peptides-list">
  Binding threshold:
  <input type="range" id="slider" value="500" min="1" max="2500">
  &nbsp;&nbsp;
  <span id="slider-type"></span>
  <span id="tval">500</span><span id="suffix">nM</span>&nbsp;
  <select name="sort-value">
      <option selected value="ic50">IC50</option>
      <option value="percentile">Percentile</option>
  </select>
  <button id="toggle-left-column">Hide Details</button>
  <button id="toggle-thymic-deletion">Filter by Thymic Deletion</button>
  <span id="close-inspector" title="Close inspector.">&times;</span>
  <div id="peptides"></div>
</div>

<script src="/static/js/d3.min.js"></script>
<script src="/static/js/underscore-min.js"></script>
<script src="/static/js/peptides.js"></script>
<script>
{% for array_name, data in [("peptide_array", peptides),
  ("no_thymic_deletion_peptide_array", peptides_no_thymic_deletion)] %}
{{ array_name }} = [
  {% for peptide in data %}
    {
      chr: "{{ peptide['chr'] }}",
      pos: {{ peptide['pos'] }},
      ref: "{{ peptide['ref'] }}",
      alt: "{{ peptide['alt'] }}",
      sequence: "{{ peptide['Peptide'] }}",
      length : "{{ peptide['Peptide']|length }}",
      mutation : "{{ peptide['PeptideMutationInfo'] }}",
      gene : "{{ peptide['Gene'] }}",
      transcriptId : "{{ peptide['TranscriptId'] }}",
      description : "{{ peptide['Description'] }}",
      mutStart: {{ peptide['MutationStart'] }},
      mutEnd : {{ peptide['MutationEnd'] }},
      epitopes: [
        {% for epitope in peptide['Epitopes'] %}
          {
            start: {{ epitope['EpitopeStart'] }},
            length: {{ epitope['EpitopeEnd'] - epitope['EpitopeStart'] }},
            scores: {
              {% for score in epitope['MHC_Allele_Scores'] %}
                "{{ score['Allele'] }}" : {
                   percentile : {{ score['MHC_PercentileRank'] }},
                   bindingScore : {{ score['MHC_IC50'] }},
                   thymicDeletion : {{ score['ThymicDeletion'] }}
                },
              {% endfor %}
            },
            sequence: "{{ epitope['Epitope'] }}",
          },
        {% endfor %}
      ],
    },
  {% endfor %}
];
{% endfor %}
peptides.run(peptide_array, no_thymic_deletion_peptide_array);
</script>
{% endblock %}
